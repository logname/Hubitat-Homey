<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hubitat Elevation Settings</title>
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 30px;
    }
    
    .field {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: 500;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #00A4E4;
    }
    
    button {
      background-color: #00A4E4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    
    button:hover {
      background-color: #0088c2;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #004085;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    
    .info h3 {
      margin-top: 0;
      font-size: 16px;
    }
    
    .info ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .info li {
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    
    .info code {
      background-color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 13px;
      word-break: break-all;
      user-select: all;
      cursor: text;
    }
    
    .info p {
      word-wrap: break-word;
      max-width: 100%;
    }
    
    input[type="number"], input[type="checkbox"] {
      margin-right: 5px;
    }
    
    small {
      display: block;
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Hubitat Elevation Settings</h1>
  
  <div class="info">
    <h3>Setup Instructions</h3>
    <ol>
      <li>Open your Hubitat Elevation web interface</li>
      <li>Go to <strong>Apps</strong> → <strong>Add Built-In App</strong> → <strong>Maker API</strong></li>
      <li>Select the devices you want to control from Homey</li>
      <li>Copy the <code>App ID</code> and <code>Access Token</code> from the Maker API page</li>
      <li>Enter your Hubitat's local IP address below (e.g., 192.168.1.100)</li>
      <li>Test the connection and save</li>
    </ol>
  </div>

  <div class="info">
    <h3>Enable Real-time Updates (IMPORTANT)</h3>
    <p><strong style="color: red;">Critical:</strong> In Hubitat Maker API, there are TWO webhook fields. You MUST use the correct one:</p>
    <ol>
      <li>Open Hubitat → Apps → Maker API</li>
      <li>Scroll down and find <strong>"URL to send device events to by POST"</strong> (NOT "Send Device Events to")</li>
      <li>Enter exactly: <code id="webhook-url-full" style="background: #fff; padding: 5px; display: inline-block;">http://[HOMEY-IP]:[PORT]/api/app/com.hubitat.elevation/webhook</code></li>
      <li>Replace [HOMEY-IP] with your Homey IP and [PORT] with port shown below</li>
      <li>Click <strong>Update</strong></li>
      <li>Toggle a device in Hubitat and watch the logs below - you should see "WEBHOOK:" entries</li>
    </ol>
    <p><strong>Your exact webhook URL:</strong> <code id="webhook-url-exact" style="background: #ffa; padding: 5px; display: block; margin-top: 10px; font-size: 14px; font-weight: bold;">Loading...</code></p>
    <p><strong>Webhook test:</strong> <button id="test-webhook-button" style="margin-left: 10px;">Test Webhook</button></p>
    <div id="webhook-test-result" style="margin-top: 10px; display: none;"></div>
    <p><strong>Last webhook received:</strong> <span id="last-webhook-time">Never</span></p>
    <p><strong>Last webhook data:</strong> <code id="last-webhook-data" style="background: #fff; padding: 5px; display: inline-block;">None</code></p>
    <p style="color: #d00;"><strong>If you don't see webhook logs when toggling devices in Hubitat, the webhook URL is not configured correctly in Maker API!</strong></p>
  </div>

  <div class="info">
    <h3>App Logs (Live)</h3>
    <button id="clear-logs-button">Clear Logs</button>
    <pre id="app-logs" style="background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; margin-top: 10px; user-select: text; cursor: text; white-space: pre-wrap; word-wrap: break-word;">Waiting for logs...</pre>
  </div>
  
  <div class="field">
    <label for="hubitat_ip">Hubitat IP Address</label>
    <input type="text" id="hubitat_ip" placeholder="192.168.1.100">
  </div>
  
  <div class="field">
    <label for="app_id">Maker API App ID</label>
    <input type="text" id="app_id" placeholder="123">
  </div>
  
  <div class="field">
    <label for="maker_api_token">Maker API Access Token</label>
    <input type="text" id="maker_api_token" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
  </div>
  
  <div class="field">
    <label for="poll_interval">Polling Interval (seconds)</label>
    <input type="number" id="poll_interval" min="5" max="300" value="30" placeholder="30">
    <small>How often to check device status when webhooks are unavailable (5-300 seconds).</small>
  </div>
  
  <div class="field">
    <label>
      <input type="checkbox" id="enable_logging" />
      Enable Debug Logging
    </label>
    <small>Show detailed logs above. Disable to reduce clutter after setup is complete.</small>
  </div>
  
  <button id="test-button">Test Connection</button>
  <button id="save-button">Save Settings</button>
  
  <div id="status" class="status"></div>
  
  <script>
    function onHomeyReady(Homey) {
      // Load current settings
      Homey.get('hubitat_ip', function(err, value) {
        if (!err && value) {
          document.getElementById('hubitat_ip').value = value;
        }
      });
      
      Homey.get('app_id', function(err, value) {
        if (!err && value) {
          document.getElementById('app_id').value = value;
        }
      });
      
      Homey.get('maker_api_token', function(err, value) {
        if (!err && value) {
          document.getElementById('maker_api_token').value = value;
        }
      });

      // Load poll interval
      Homey.get('poll_interval', function(err, value) {
        if (!err && value) {
          document.getElementById('poll_interval').value = value;
        } else {
          document.getElementById('poll_interval').value = 30;
        }
      });

      // Load logging preference
      Homey.get('enable_logging', function(err, value) {
        if (!err && value !== undefined) {
          document.getElementById('enable_logging').checked = value;
          updateLoggingVisibility(value);
        } else {
          document.getElementById('enable_logging').checked = true;
          updateLoggingVisibility(true);
        }
      });

      // Handle logging toggle
      document.getElementById('enable_logging').addEventListener('change', function() {
        const enabled = this.checked;
        Homey.set('enable_logging', enabled);
        updateLoggingVisibility(enabled);
      });

      function updateLoggingVisibility(enabled) {
        const logsSection = document.querySelector('.info:has(#app-logs)');
        if (logsSection) {
          logsSection.style.display = enabled ? 'block' : 'none';
        }
      }

      // Load last webhook info
      Homey.get('last_webhook_time', function(err, value) {
        if (!err && value) {
          document.getElementById('last-webhook-time').textContent = value;
        }
      });

      Homey.get('last_webhook_data', function(err, value) {
        if (!err && value) {
          document.getElementById('last-webhook-data').textContent = value;
        }
      });

      // Refresh webhook info every 5 seconds
      setInterval(function() {
        Homey.get('last_webhook_time', function(err, value) {
          if (!err && value) {
            document.getElementById('last-webhook-time').textContent = value;
          }
        });
        Homey.get('last_webhook_data', function(err, value) {
          if (!err && value) {
            document.getElementById('last-webhook-data').textContent = value;
          }
        });
      }, 5000);

      // Load and display app logs
      function updateLogs() {
        Homey.get('app_logs', function(err, value) {
          if (!err && value) {
            const logsDiv = document.getElementById('app-logs');
            logsDiv.textContent = value;
            logsDiv.scrollTop = logsDiv.scrollHeight; // Auto-scroll to bottom
          }
        });
      }
      
      // Update logs every 2 seconds
      updateLogs();
      setInterval(updateLogs, 2000);
      
      // Clear logs button
      document.getElementById('clear-logs-button').addEventListener('click', function() {
        Homey.set('app_logs', '');
        document.getElementById('app-logs').textContent = 'Logs cleared...';
      });

      // Get and display Homey IP and port for webhook configuration
      const homeyIP = window.location.hostname;
      const homeyPort = window.location.port || '80';
      const webhookURL = `http://${homeyIP}:${homeyPort}/api/app/com.hubitat.elevation/webhook`;
      
      const webhookElementFull = document.getElementById('webhook-url-full');
      if (webhookElementFull) {
        webhookElementFull.textContent = `http://[HOMEY-IP]:${homeyPort}/api/app/com.hubitat.elevation/webhook`;
      }
      
      const webhookElementExact = document.getElementById('webhook-url-exact');
      if (webhookElementExact) {
        webhookElementExact.textContent = webhookURL;
      }

      // Test webhook button
      document.getElementById('test-webhook-button').addEventListener('click', function() {
        const resultDiv = document.getElementById('webhook-test-result');
        resultDiv.style.display = 'block';
        
        // Check if accessing from cloud URL
        if (window.location.hostname.includes('my.homey.app') || window.location.hostname.includes('athom.com')) {
          resultDiv.textContent = '⚠ Warning: Webhook test only works from local URL (http://192.168.x.x:xxxx). You are accessing from cloud URL.';
          resultDiv.className = 'status error';
          return;
        }
        
        resultDiv.textContent = 'Testing webhook...';
        resultDiv.className = 'status';
        
        fetch(webhookURL + '?deviceId=999&name=test&value=test')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              resultDiv.textContent = '✓ Webhook is working! Response: ' + JSON.stringify(data);
              resultDiv.className = 'status success';
            } else {
              resultDiv.textContent = '✗ Webhook error: ' + data.error;
              resultDiv.className = 'status error';
            }
          })
          .catch(err => {
            resultDiv.textContent = '✗ Webhook failed: ' + err.message;
            resultDiv.className = 'status error';
          });
      });
      
      // Test connection button
      document.getElementById('test-button').addEventListener('click', function() {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'none';
        
        const ip = document.getElementById('hubitat_ip').value;
        const appId = document.getElementById('app_id').value;
        const token = document.getElementById('maker_api_token').value;
        
        if (!ip || !appId || !token) {
          showStatus('Please fill in all fields', 'error');
          return;
        }
        
        // Temporarily save settings for test
        Homey.set('hubitat_ip', ip);
        Homey.set('app_id', appId);
        Homey.set('maker_api_token', token);
        
        // Test connection via app
        Homey.api('GET', '/test-connection', function(err, result) {
          if (err) {
            showStatus('Connection failed: ' + err.message, 'error');
          } else if (result.success) {
            showStatus('Connection successful!', 'success');
          } else {
            showStatus('Connection failed: ' + result.error, 'error');
          }
        });
      });
      
      // Save button
      document.getElementById('save-button').addEventListener('click', function() {
        const ip = document.getElementById('hubitat_ip').value;
        const appId = document.getElementById('app_id').value;
        const token = document.getElementById('maker_api_token').value;
        const pollInterval = parseInt(document.getElementById('poll_interval').value);
        
        if (!ip || !appId || !token) {
          showStatus('Please fill in all fields', 'error');
          return;
        }
        
        if (pollInterval < 5 || pollInterval > 300) {
          showStatus('Poll interval must be between 5 and 300 seconds', 'error');
          return;
        }
        
        Homey.set('hubitat_ip', ip, function(err) {
          if (err) {
            showStatus('Error saving IP address', 'error');
            return;
          }
          
          Homey.set('app_id', appId, function(err) {
            if (err) {
              showStatus('Error saving App ID', 'error');
              return;
            }
            
            Homey.set('maker_api_token', token, function(err) {
              if (err) {
                showStatus('Error saving Access Token', 'error');
                return;
              }
              
              Homey.set('poll_interval', pollInterval, function(err) {
                if (err) {
                  showStatus('Error saving poll interval', 'error');
                  return;
                }
                
                showStatus('Settings saved successfully! Restart devices for poll interval to take effect.', 'success');
              });
            });
          });
        });
      });
      
      function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
      }
      
      Homey.ready();
    }
  </script>
</body>
</html>
